\documentclass[../hydrozoa.tex]{subfiles}
\graphicspath{{\subfix{../images/}}}
\begin{document}

\chapter{L2 blocks}%
\label{h:l2-blocks}%

It would be inefficient for a head's peers to confirm each L2 ledger event individually.
Instead, they confirm an entire block of L2 ledger events at every round of the Hydrozoa L2 consensus protocol.

Each block contains a sequence of L2 ledger events that operates on the ledger state reached in the previous block.
Depending on the types of L2 ledger events in this sequence and the peers' intent to continue operating the head, there are four kinds of L2 blocks in Hydrozoa:
\begin{description}
  \item[Minor block.] A block that contains a sequence of only L2 transactions (no withdrawals or settlement).
    Minor blocks have no effect on the head's L1 utxo state and only affect the L2 ledger state's \code{activeUtxos} set.
  \item[Major block.] A block that contains a sequence of L2 transactions and withdrawals, ending with an L2 settlement, and references a set of L1 deposits.
    Each major block also contains an L1 settlement transaction that pays out L1 utxos corresponding to the block's L2 withdrawals and absorbs L1 deposits corresponding to the block's deposits into the head's treasury.
    The major block's L2 settlement event must correspond to its L1 settlement transaction.
  \item[Initial block.] The minor block with which the head is initialized.
    It contains no L2 transactions and results in an empty L2 ledger state.
  \item[Final block.] The major block with which the head is finalized.
    Its L2 settlement event results in an empty L2 ledger state.
\end{description}

Every block is versioned by a unique pair of integers---the major and minor versions of the block:
\begin{itemize}
  \item The initial block has both major and minor versions set to zero.
  \item A minor block keeps its predecessor's major version and increments the minor version.
  \item A major block increments the major version and resets the minor version to zero.
  \item The final block increments the major version and resets the minor version to zero.
\end{itemize}

Every block is also tagged by its block number, which counts the block's predecessors.

This chapter describes how to create and validate L2 blocks.

\section{Block validation environment}%
\label{h:l2-block-validation-environment}%

Every peer requires access to an up-to-date source of the following information:
\begin{equation*}
\begin{split}
  \T{BlockValidationEnv} &\coloneq \left\{
    \begin{array}{lll}
      \T{timeCurrent} &::& \T{PosixTime} \\
      \T{paramsBlockValidation} &::& \T{ParamsBlockValidtion} \\
      \T{stateL1} &::& \T{MultisigHeadStateL1} \\
      \T{stateL2} &::& \T{LedgerStateL2} \\
      \T{eventsL2} &::& \T{Table} \; \T{EventL2} \\
    \end{array}\right\} \\
  \T{ParamsBlockValidation} &\coloneq \left\{
    \begin{array}{lll}
      \T{depositMarginMaturity} &::& \T{UDiffTime} \\
      \T{depositMarginExpiry} &::& \T{UDiffTime}
    \end{array}\right\} \\
  \T{EventL2} &\coloneq \left\{
    \begin{array}{lll}
      \T{timeReceived} &::& \T{PosixTime} \\
      \T{eventId} &::& \T{TxId} \\
      \T{eventType} &::& \T{EventTypeL2} \\
      \T{event} &::& \T{Tx^{L2}} \\
      \T{blockNum} &::& \T{Maybe} \; \T{UInt}
    \end{array}\right\} \\
  \T{EventTypeL2} &\coloneq \T{Transaction} \mid \T{Withdrawal} \mid \T{Settlement}
\end{split}
\end{equation*}

These fields are interpreted as follows:
\begin{description}
  \item[current time.] The current POSIX time, synchronized via the NTP protocol \citep{MillsEtAlNetworkTimeProtocol2010}.
  \item[block validation params.] The head's block validation parameters:
    \begin{description}
      \item[deposit maturity margin.] After an L1 deposit is created on L1, the peers must wait for this non-negative time duration before attempting to absorb it into the head's treasury.
      \item[deposit expiry margin.] If less than this non-negative time duration is left before an L1 deposit's deadline, then the peers must not attempt to absorb it into the head's treasury.
    \end{description}
  \item[L1 state.] The head's L1 utxo state in the multisig regime (\cref{h:l1-multisig-utxo-state}).%
    \footnote{The head's L1 state is only needed to create/validate major and final blocks, which cannot be done when the head is in the L1 rule-based regime.}
  \item[L2 state.] The head's L2 ledger state (\cref{h:l2-ledger}) as of the latest confirmed block.
  \item[L2 events.] The table of L2 events witnessed by the peer to date,%
    \footnote{It's up to the L2 consensus protocol whether this table stores all L2 events ever witnessed by the peer, or just the recent events up to a time-based or block-based cutoff.}
    which must be unique on \code{eventId} and sorted in the ascending order of \code{timeReceived}:
    \begin{description}
      \item[time received.] The POSIX time at which the peer received the event.
      \item[event ID.] The transaction ID corresponding to the event's effect on the L2 \code{activeUtxos} set (\cref{h:l2-ledger}).
      \item[event type]. The L2 event is a transaction, withdrawal, or settlement.
      \item[event.] The transaction representing the event's effect on the L2 \code{activeUtxos} set.
      \item[blockNum.] The block number of the block (if any) that includes the event, regardless of whether the block is confirmed.
    \end{description}
\end{description}

With the above information, a peer can create and determine the validation status of a block:
\begin{equation*}
\begin{split}
  \T{ValidationStatus} \coloneq&\;
    \T{Valid} \\\mid&\;
    \T{NotYetValid} \\\mid&\;
    \T{Invalid}
\end{split}
\end{equation*}
These statuses are interpreted as follows:
\begin{description}
  \item[Valid.] The block is valid and should be confirmed by the peer.
  \item[Not yet valid.] The peer has detected an error that could be resolved if the peer waits and tries again---e.g., the peer may soon witness a pending L2 event that was included in the block.
  \item[Invalid.] The peer has detected an error that cannot be resolved by waiting.
\end{description}

\section{Initial block}%
\label{h:l2-initial-block}%

The initial block is a notional block that does not need to be created, validated, or confirmed by the peers.
It is just assumed to be confirmed when the peers initialize the head.

It is equivalent to a minor block with an empty sequence of L2 transactions that transitions to an empty L2 ledger state.

\section{Minor block}%
\label{h:l2-minor-block}%

A minor block rearranges the L2 ledger state's active utxo set without depositing any new funds from L1 or withdrawing any funds to L1.
As such, minor blocks do not affect the head's L1 state while it is in the multisig regime.

\subsection{Create a minor block}%
\label{h:l2-minor-block-create}%

% TODO - create

\subsection{Validate a minor block}%
\label{h:l2-minor-block-validate}%

% TODO - validate

\section{Major block}%
\label{h:l2-major-block}%

% TODO Major block

\subsection{Create a major block}%
\label{h:l2-major-block-create}%

% TODO - create

\subsection{Validate a major block}%
\label{h:l2-major-block-validate}%

% TODO - validate

% TODO major blocks created in two cases:
% - Accumulation of unabsorbed L1 deposits or unsettled L2 withdrawals
% - Within safety margin of L1 treasury transition boundary (consensus protocol parameter)

\section{Final block}%
\label{h:l2-final-block}%

% TODO Final block

\subsection{Create a final block}%
\label{h:l2-final-block-create}%

% TODO - create

\subsection{Validate a final block}%
\label{h:l2-final-block-validate}%

% TODO - validate

\end{document}
