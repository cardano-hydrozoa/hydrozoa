\documentclass[../hydrozoa.tex]{subfiles}
\graphicspath{{\subfix{../images/}}}
\begin{document}

\section{Rule-based regime}%
\label{h:rule-based-regime}%
If the peers stop responding to each other in the offchain consensus protocol, the rule-based regime ensures that their funds can still be withdrawn from the Hydrozoa treasury according to the latest confirmed snapshot.
It is less cost-efficient and more complex than the multisig regime, but it serves as a fallback when offchain consensus breaks down.

In the rule-based regime, the Hydrozoa head's treasury is managed by a suite of Plutus scripts:
\begin{itemize}
  \item The dispute resolution scripts (\cref{h:rule-based-dispute-resolution}) arbitrate the peers' dispute about the latest offchain snapshot confirmed by the offchain consensus protocol before it stalled.
  \item The treasury spending validator (\cref{h:rule-based-treasury}) awaits resolution and then manages withdrawals from the head's treasury based on the resolved snapshot.
\end{itemize}

The rule-based regime does not manage any unabsorbed deposits left over from the multisig regime.
Depositors can retrieve them with post-dated refund transactions (\cref{h:multisig-refund}) from the multisig regime.

\subsection{Utxo state}%
\label{h:rule-based-utxo-state}

\subsubsection{Treasury state}

In the rule-based regime, the head's treasury utxo is at the head's Plutus-based treasury address (\cref{h:rule-based-treasury}).
It holds the head's beacon token and all treasury funds from the multisig regime (\cref{h:multisig-utxo-state}).

The treasury utxo must have the following datum type, which defines its unresolved and resolved states in the rule-based regime:
\begin{equation*}
\begin{split}
  \T{RuleBasedTreasuryDatum} &\coloneq\;
    \T{Resolved} \; \T{ResolvedDatum} \mid
    \T{Unresolved} \; \T{UnresolvedDatum} \\
  \T{ResolvedDatum} &\coloneq\;\left\{
    \begin{array}{lll}
      \T{activeUtxos}  &::& \mathcal{RH}_{32} \; \T{UtxoSet} \\
      \T{version} &::& (\T{Int}, \T{Int}) \\
      \T{params} &::& \mathcal{H}_{32} \; \T{HeadParams}
    \end{array}\right\} \\
  \T{UnresolvedDatum} &\coloneq\;\left\{
    \begin{array}{lll}
      \T{disputeId} &::& \T{AssetName} \\
      \T{peers} &::& \T{[VerificationKey]} \\
      \T{nPeers} &::& \T{Int} \\
      \T{votingDeadline} &::& \T{PosixTime} \\
      \T{majorVersion} &::& \T{Int} \\
      \T{params} &::& \mathcal{H}_{32} \; \T{HeadParams}
    \end{array}\right\}
\end{split}
\end{equation*}

The resolved treasury's datum is the same as the multisig treasury's datum, except that the single-integer \code{majorVersion} field is replaced by the full \code{version} field, which includes both the major and minor version numbers of the resolved snapshot.

The unresolved treasury's datum fields are interpreted as follows:
\begin{description}
  \item[dispute ID.] The unique identifier used as the asset name of the dispute tokens (see below).
  \item[peers.] The peers' public keys.
  \item[n peers.] The number of peers in the head.
  \item[voting deadline.] A POSIX time before which votes can be cast in the dispute.
  \item[major version.] The treasury's major version when it transitioned to the rule-based regime.
  \item[params.] A 32-byte Blake2b-256 hash (\inlineColored{$\mathcal{H}_{32}$}) of the head's offchain consensus parameters (\cref{h:offchain-consensus-protocol}).
\end{description}

\subsubsection{Dispute state}

Besides the treasury utxo, the head's state in the rule-based regime also includes the vote utxos for the dispute.
Each of these utxos is at the head's Plutus-based dispute address and holds one or more of the dispute's fungible tokens:
\begin{itemize}
  \item The policy ID corresponds to the head's native script (in minting policy form) (\cref{h:multisig-regime}).
  \item The first four bytes of the asset name are equal to the CIP-67
    \citep{AlessandroKonradThomasVellekoopCIP67AssetName2022}
    prefix for class label \inlineColored{3477}, which corresponds to Hydrozoa head dispute tokens.%
    \footnote{We chose \inlineColored{3477} because it spells ``DISP'' (short for dispute) on a phone dial pad.}
  \item The last 28 bytes of the asset name are equal to the Blake2b-224 hash (\inlineColored{$\mathcal{H}_{28}$}) of the multisig treasury utxo spent in the head's transition to the rule-based regime (\cref{h:rule-based-transition}).
\end{itemize}

Each vote utxo has this datum type:
\begin{equation*}
\begin{split}
  \T{VoteDatum} &\coloneq \left\{
    \begin{array}{lll}
      \T{key}  &::& \T{Int} \\
      \T{link} &::& \T{Int} \\
      \T{peer} &::& \T{Maybe} \; \T{PubKeyHash} \\
      \T{voteStatus} &::& \T{VoteStatus}
    \end{array}\right\}\\
  \T{VoteStatus} &\coloneq \T{NoVote} \mid \T{Abstain} \mid \T{Vote} \; \T{VoteDetails} \\
  \T{VoteDetails} &\coloneq \left\{
    \begin{array}{lll}
      \T{activeUtxos} &::& \mathcal{RH}_{32} \; \T{UtxoSet} \\
      \T{minorVersion} &::& \T{Int}
    \end{array}\right\}
\end{split}
\end{equation*}

These fields are interpreted as follows:
\begin{description}
  \item[key.] An integer that uniquely identifies the vote utxo.
  \item[link.] An integer that uniquely references another vote utxo by its \code{key}.
  \item[peer.] The public-key hash of the peer (if any) who can cast the vote in this utxo. It is only empty for the default vote utxo (with \code{key} 0), which contains a vote that is automatically cast at the transition to the rule-based regime (\cref{h:rule-based-transition}).
  \item[vote status.] Either no vote, a vote to abstain, or a vote for a minor snapshot.
  \item[active utxos.] A 32-byte Merkle root hash (\inlineColored{$\mathcal{RH}_{32}$}) of the offchain ledger's active utxo set, as of the snapshot voted by the peer.
  \item[minor version.] The minor version of the minor snapshot voted by the peer. This snapshot's major version must match the major version that the treasury had when it transitioned to the rule-based regime.
\end{description}

Collectively, the vote utxos constitute a linked list data structure onchain.

\subsection{Transition to rule-based regime}%
\label{h:rule-based-transition}

The offchain consensus protocol pairs every multisig treasury utxo that it creates with a post-dated transaction that transitions the treasury to the rule-based regime (\cref{h:offchain-consensus-protocol}).

While offchain consensus holds, the peers store these post-dated transactions without submitting.
However, if the multisig utxo is not spent by the time its corresponding post-dated transaction becomes valid, then offchain consensus is assumed to have stalled.
In that case, every peer should trigger the transition to the rule-based regime by submitting the transaction to Cardano.

The transaction body is as follows:
\begin{enumerate}
  \item Spend the multisig treasury utxo (\code{multisigTreasury}).
    Let \code{mt} be its datum.
  \item Let \code{headMp} be the head's native script minting policy.
  \item Let \code{votingDeadline} be the voting deadline for this dispute, as defined by the offchain consensus for this transition to the rule-based regime.
  \item Let \code{disputeId} be the CIP-67 prefix for 3477, concatenated with the Blake2b-224 hash of the \code{multisigTreasury} output reference.
  \item Let \code{peers} be a list of the peers' public keys and \code{nPeers} be its length.
  \item Mint \code{(nPeers + 1)} dispute tokens of \code{(headMp, disputeId)}.
  \item Create the rule-based treasury utxo (\code{ruleBasedTreasury}), containing the funds and beacon token from the \code{multisigTreasury} and this datum:
    \begin{equation*}
    \begin{split}
      \T{transitionTreasuryDatum} \coloneq \T{Unresolved} \;\left\{
        \begin{array}{lll}
          \T{disputeId} &=& \T{disputeId} \\
          \T{peers} &=& \T{peers} \\
          \T{nPeers} &=& \T{nPeers} \\
          \T{votingDeadline} &=& \T{votingDeadline} \\
          \T{majorVersion} &=& \T{mt.majorVersion} \\
          \T{params} &=& \T{mt.params}
        \end{array}\right\}
    \end{split}
    \end{equation*}
  \item For \inlineColored{$i$} iterated from 0 to \code{nPeers}, create a vote utxo with one dispute token and this datum:%
    \footnote{The indices of the \inlineColored{peers} list start from 1.}
    \begin{equation*}
    \begin{split}
      \T{initVoteDatum} \; \T{mt} \; i &\coloneq \left\{
        \begin{array}{lll}
          \T{key}  &=& i \\
          \T{link} &=& i < \T{nPeers} \;?\; (i + 1) : 0 \\
          \T{peer} &=& 0 < i \;?\; \T{Just} \; (\mathcal{H}_{32} \; \T{peers}[i]) : \T{Nothing} \\
          \T{voteStatus} &=& \T{voteStatus} \; i
        \end{array}\right\}\\
      \T{voteStatus} \; 0 &\coloneq \T{Vote} \; \left\{
        \begin{array}{lll}
          \T{activeUtxos} &=& \T{mt.activeUtxos} \\
          \T{minorVersion} &=& 0
        \end{array}\right\}\\
      \T{voteStatus} \; \_ &\coloneq \T{NoVote}
    \end{split}
    \end{equation*}
\end{enumerate}

\subsection{Dispute resolution}%
\label{h:rule-based-dispute-resolution}

During the voting period of a dispute, each peer gets one opportunity to cast their vote on the latest minor snapshot confirmed by the offchain consensus protocol before it stalled.
After all votes are cast or the voting period ends, the dispute state can be resolved to a single vote utxo containing the latest snapshot among the votes.

\subsubsection{Spending validator for voting}

Voting is handled by the Plutus-based spending validator of the dispute address.
Redeemers:
\begin{description}
  \item[Vote.] Replace the input's no-vote status with an abstention or a valid vote for a snapshot. Conditions:
    \begin{itemize}
      \item Verify the vote utxo spent input:
        \begin{enumerate}
          \item Let \code{inputVoteOutref} be the output reference of the input being spent.
          \item Let \code{inputVote} be the input being spent.
            There must not be any other spent input matching \code{inputVoteOutref} on tx hash.
          \item The \code{voteStatus} field of \code{inputVote} must be empty.
          \item The transaction must be signed by the \code{peer} field of \code{inputVote}, if it is non-empty.
          \item Let \code{(headMp, disputeId)} be the minting policy and asset name of the only non-ADA tokens in \code{inputVote}.
        \end{enumerate}
      \item Verify the treasury reference input:
        \begin{enumerate}[resume]
          \item Let \code{treasury} be the only reference input matching \code{inputVoteOutref} on tx hash.
          \item A head beacon token of \code{headMp} and CIP-67 prefix \inlineColored{4937} must be in \code{treasury}.
          \item \code{disputeId} must match the \code{disputeId} field of the \code{Unresolved} datum in \code{treasury}.
          \item The transaction's time-validity upper bound must not exceed the \code{votingDeadline} field of \code{treasury}.
        \end{enumerate}
      \item Verify the redeemer:
        \begin{enumerate}[resume]
          \item Let \code{voteRedeemer} be an \emph{optional} redeemer argument with this type:
            \begin{equation*}
            \begin{split}
              \T{VoteRedeemer} &\coloneq \left\{
                \begin{array}{lll}
                  \T{minorSnapshot} &::& \T{MinorSnapshot} \\
                  \T{multisig} &::& [\T{Signature}]
                \end{array}\right\}\\
              \T{MinorSnapshot} &\coloneq \left\{
              \begin{array}{lll}
                \T{activeUtxos} &::& \mathcal{RH}_{32} \; \T{UtxoSet} \\
                \T{majorVersion} &::& \T{Int} \\
                \T{minorVersion} &::& \T{Int}
              \end{array}\right\}
            \end{split}
            \end{equation*}
          \item If \code{voteRedeemer} is provided, then the \code{multisig} field of \code{voteRedeemer} must have signatures of the \code{minorSnapshot} field of \code{voteRedeemer} for all the public keys in the \code{peers} field of \code{treasury}.
        \end{enumerate}
      \item Verify the vote utxo output:
        \begin{enumerate}[resume]
          \item Let \code{outputVote} be an output with the same number of \code{(headMp, disputeId)} tokens and same address as \code{inputVote}. It must not hold any other non-ADA tokens.
          \item If \code{voteRedeemer} is provided, the \code{voteStatus} field of \code{outputVote} must be a \code{Vote} matching \code{voteRedeemer} on the \code{activeUtxos} and \code{minorVersion} fields.
            Otherwise, it must be \code{Abstain}.
          \item All other datum fields must match between \code{inputVote} and \code{outputVote}.
        \end{enumerate}
    \end{itemize}
  \item[Tally.] Refer validation to the staking validator of the dispute address.
    Conditions:
    \begin{enumerate}
      \item Let \code{tallyValidator} be the script hash of the staking validator for tallying, provided as a static parameter to the spending validator for voting.
      \item Let \code{inputVoteOutref} be the output reference of the input being spent.
      \item The transaction's redeemers list must show \code{tallyValidator} being invoked to withdraw-zero with a redeemer that mentions the tx hash of \code{inputVoteOutref}.
    \end{enumerate}
  \item[Resolve.] The remaining vote utxo can be spent when the treasury utxo is spent.
    Conditions:
    \begin{enumerate}
      \item Let \code{inputVoteOutref} be the output reference of the input being spent.
      \item Let \code{treasury} be the only reference input matching \code{inputVoteOutref} on tx hash.
      \item A head beacon token of \code{headMp} and CIP-67 prefix \inlineColored{4937} must be in \code{treasury}.
    \end{enumerate}
\end{description}

\subsubsection{Staking validator for tallying}

Tallying is handled by the Plutus-based staking validator of the dispute address.
Redeemers:
\begin{description}
  \item[Tally.]
\end{description}

% TODO - Tally
% Remove a node if both it and its parent contain a vote, or if the transaction validity starts at or after the voting deadline.

% Spending validator -> staking validator
% staking validator looks for exactly 2 inputs with dispute tokens.
% dispute ID of these tokens must match redeemer.

\subsection{Treasury}%
\label{h:rule-based-treasury}

% TODO Treasury

% TODO - Resolve
% Compare the full version number between the treasury datum and the singleton node from dispute resolution:
%   - if the singleton node's version is greater, update the treasury datum to its version number and active_utxo field.
%   - otherwise, keep the treasury datum unchanged.

% TODO - Withdraw
% - Spend the treasury utxo.
% - Output an updated treasury utxo.
% - Output a withdrawal.
% - Prove that the new treasury's active_utxo results from
%   removing the withdrawn utxo from the old treasury's active_utxo.

% TODO - Deinit
% - Spend the treasury utxo.
% - Prove that the treasury's active_utxo is empty.

% TODO - Multisig override
% Do whatever you want if the transaction is multi-signed by all peers.

\end{document}
